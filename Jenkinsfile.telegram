// Jenkins Pipeline for Telegram Bot Service
// This pipeline handles building, testing, and deploying the Telegram Bot microservice

pipeline {
    agent any

    environment {
        // Service Configuration
        SERVICE_NAME = 'telegram-bot-service'
        SERVICE_PORT = '8080'  // Telegram bot doesn't expose HTTP port by default

        // Docker Configuration - Hybrid Approach
        // Local image name (matches docker-compose convention)
        LOCAL_IMAGE_NAME = 'small-scale-factory-micro_telegram-bot-service'

        // Remote image name (for Docker Hub registry)
        DOCKER_REGISTRY = 'docker.io'
        REMOTE_IMAGE_NAME = 'pichc137/factory-telegram-bot-service'
        DOCKER_CREDENTIALS_ID = 'docker-hub-credentials'

        IMAGE_TAG = "${BUILD_NUMBER}-${GIT_COMMIT.take(7)}"

        // Gradle Configuration
        GRADLE_OPTS = '-Dorg.gradle.daemon=false'

        // Deployment
        DEPLOY_ENV = 'development'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '5'))
        timeout(time: 20, unit: 'MINUTES')
        timestamps()
        disableConcurrentBuilds()
    }

    triggers {
        // GitHub webhook trigger - builds automatically on push events
        githubPush()
    }

    stages {
        stage('ğŸ” Checkout') {
            steps {
                script {
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘       TELEGRAM BOT SERVICE - CI/CD PIPELINE          â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "ğŸ“¦ Service: ${SERVICE_NAME}"
                    echo "ğŸŒ¿ Branch: ${env.GIT_BRANCH}"
                    echo "ğŸ“ Commit: ${env.GIT_COMMIT}"
                    echo "ğŸ—ï¸  Build: #${BUILD_NUMBER}"
                }
                checkout scm
            }
        }

        stage('ğŸ“Š Environment Info') {
            steps {
                sh '''
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "           Build Environment Information"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "â˜• Java Version:"
                    java -version
                    echo ""
                    echo "ğŸ”§ Gradle Version:"
                    ./gradlew --version
                    echo ""
                    echo "ğŸ³ Docker Version:"
                    docker --version
                    echo ""
                    echo "ğŸ“‚ Workspace: ${WORKSPACE}"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                '''
            }
        }

        stage('ğŸ”¨ Build Telegram Bot Service') {
            steps {
                script {
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "           Building Telegram Bot Service"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                }
                sh '''
                    # Build only the telegram-bot service and its dependencies
                    ./gradlew :telegram-bot-service:clean :telegram-bot-service:build -x test --stacktrace

                    echo ""
                    echo "âœ… Telegram bot service build completed successfully"
                '''
            }
        }

        stage('ğŸ§ª Test Telegram Bot Service') {
            steps {
                script {
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "           Running Telegram Bot Service Tests"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                }
                sh '''
                    # Run tests for telegram-bot service
                    ./gradlew :telegram-bot-service:test --stacktrace

                    echo ""
                    echo "âœ… All tests passed"
                '''
            }
            post {
                always {
                    // Publish test results
                    junit testResults: '**/telegram-bot-service/build/test-results/test/*.xml', allowEmptyResults: true

                    // Publish code coverage if available
                    script {
                        if (fileExists('telegram-bot-service/build/reports/jacoco/test/jacocoTestReport.xml')) {
                            jacoco(
                                execPattern: '**/telegram-bot-service/build/jacoco/*.exec',
                                classPattern: '**/telegram-bot-service/build/classes',
                                sourcePattern: '**/telegram-bot-service/src/main/kotlin',
                                exclusionPattern: '**/*Test*,**/*Mock*'
                            )
                        }
                    }
                }
            }
        }

        stage('ğŸ“¦ Build Fat JAR') {
            steps {
                script {
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "           Building Telegram Bot Service Fat JAR"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                }
                sh '''
                    ./gradlew :telegram-bot-service:buildFatJar --stacktrace

                    echo ""
                    echo "ğŸ“¦ Fat JAR created:"
                    ls -lh telegram-bot-service/build/libs/*-all.jar
                '''
            }
            post {
                success {
                    archiveArtifacts artifacts: 'telegram-bot-service/build/libs/*-all.jar', fingerprint: true
                }
            }
        }

        stage('ğŸ³ Build Docker Image') {
            steps {
                script {
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "           Building Docker Image (Dual Tagging)"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "ğŸ·ï¸  Local: ${LOCAL_IMAGE_NAME}:${IMAGE_TAG}"
                    echo "ğŸ·ï¸  Remote: ${REMOTE_IMAGE_NAME}:${IMAGE_TAG}"
                }
                sh '''
                    # Build image with both local and remote tags
                    docker build \
                        -f telegram-bot-service/Dockerfile \
                        -t ${LOCAL_IMAGE_NAME}:${IMAGE_TAG} \
                        -t ${LOCAL_IMAGE_NAME}:latest \
                        -t ${REMOTE_IMAGE_NAME}:${IMAGE_TAG} \
                        -t ${REMOTE_IMAGE_NAME}:latest \
                        .

                    echo ""
                    echo "âœ… Docker image built successfully with dual tags"
                    echo ""
                    echo "ğŸ“¦ Local images:"
                    docker images ${LOCAL_IMAGE_NAME} | head -2
                    echo ""
                    echo "ğŸ“¦ Remote images:"
                    docker images ${REMOTE_IMAGE_NAME} | head -2
                '''
            }
        }

        stage('ğŸ” Security Scan') {
            steps {
                script {
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "           Security Scanning (Optional)"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                }
                sh '''
                    # Optional: Run Trivy security scan if installed
                    if command -v trivy &> /dev/null; then
                        echo "ğŸ” Running Trivy security scan on local image..."
                        trivy image --severity HIGH,CRITICAL ${LOCAL_IMAGE_NAME}:${IMAGE_TAG} || true
                    else
                        echo "âš ï¸  Trivy not installed, skipping security scan"
                        echo "   Install with: sudo apt-get install trivy"
                    fi
                '''
            }
        }

        stage('ğŸš€ Push Docker Image') {
            when {
                anyOf {
                    branch 'main'
                }
            }
            steps {
                script {
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "           Pushing to Docker Registry (Remote Image Only)"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

                    withCredentials([usernamePassword(
                        credentialsId: "${DOCKER_CREDENTIALS_ID}",
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            echo "Logging into Docker registry..."
                            echo \$DOCKER_PASS | docker login ${DOCKER_REGISTRY} -u \$DOCKER_USER --password-stdin

                            echo "ğŸ“¤ Pushing ${REMOTE_IMAGE_NAME}:${IMAGE_TAG}..."
                            docker push ${REMOTE_IMAGE_NAME}:${IMAGE_TAG}

                            echo "ğŸ“¤ Pushing ${REMOTE_IMAGE_NAME}:latest..."
                            docker push ${REMOTE_IMAGE_NAME}:latest

                            echo ""
                            echo "âœ… Remote images pushed successfully to ${DOCKER_REGISTRY}"
                            echo "   - ${REMOTE_IMAGE_NAME}:${IMAGE_TAG}"
                            echo "   - ${REMOTE_IMAGE_NAME}:latest"

                            docker logout ${DOCKER_REGISTRY}
                        """
                    }
                }
            }
        }

        stage('ğŸš€ Deploy to Development') {
            when {
                anyOf {
                    branch 'develop'
                    branch 'main'
                }
            }
            steps {
                script {
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "           Deploying Telegram Bot Service (${env.BRANCH_NAME})"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "ğŸ“¦ Using pre-built image: ${LOCAL_IMAGE_NAME}:latest"
                }
                sh '''
                    # Ensure all backend services are running (telegram bot depends on them)
                    echo "ğŸ” Checking dependencies..."

                    if ! docker-compose ps | grep -q "auth-service.*Up"; then
                        echo "âš ï¸  Auth service not running, starting it first..."
                        docker-compose up -d --no-build auth-service
                        sleep 10
                    fi

                    if ! docker-compose ps | grep -q "inventory-service.*Up"; then
                        echo "âš ï¸  Inventory service not running, starting it first..."
                        docker-compose up -d --no-build inventory-service
                        sleep 10
                    fi

                    if ! docker-compose ps | grep -q "order-service.*Up"; then
                        echo "âš ï¸  Order service not running, starting it first..."
                        docker-compose up -d --no-build order-service
                        sleep 10
                    fi

                    # Stop and remove existing telegram-bot-service container
                    echo "ğŸ§¹ Cleaning up old containers..."
                    docker-compose stop telegram-bot-service || true
                    docker-compose rm -f telegram-bot-service || true

                    # Remove any dangling telegram-bot-service containers
                    docker ps -a --filter "name=small-scale-factory-micro_telegram-bot-service" --format "{{.ID}}" | xargs -r docker rm -f || true
                    docker ps -a --filter "name=telegram_bot_service" --format "{{.ID}}" | xargs -r docker rm -f || true

                    # Start telegram-bot-service using the already-built image (no rebuild)
                    echo ""
                    echo "ğŸš€ Starting telegram-bot-service with pre-built image..."
                    docker-compose up -d --no-build telegram-bot-service

                    # Wait for service to start (telegram bot doesn't have health endpoint)
                    echo ""
                    echo "â³ Waiting for telegram bot service to start..."
                    sleep 10

                    # Show service status
                    echo ""
                    echo "ğŸ“Š Service Status:"
                    docker-compose ps telegram-bot-service

                    echo ""
                    echo "ğŸ“¦ Running containers:"
                    docker ps --filter "name=telegram" --format "table {{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Names}}"

                    # Check logs for successful startup
                    echo ""
                    echo "ğŸ“‹ Recent logs:"
                    docker-compose logs --tail=20 telegram-bot-service || true
                '''
            }
        }

        stage('âœ… Smoke Tests') {
            when {
                anyOf {
                    branch 'develop'
                    branch 'main'
                }
            }
            steps {
                script {
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "           Running Smoke Tests"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                }
                sh '''
                    # Check if container is running
                    echo "ğŸ” Checking if telegram bot container is running..."
                    if docker ps | grep -q "telegram.*Up"; then
                        echo "âœ… Telegram bot container is running"
                    else
                        echo "âŒ Telegram bot container is not running"
                        exit 1
                    fi

                    # Check logs for errors
                    echo ""
                    echo "ğŸ” Checking logs for errors..."
                    if docker-compose logs telegram-bot-service | grep -i "error\|exception\|failed" | grep -v "error=false"; then
                        echo "âš ï¸  Warning: Errors found in logs"
                    else
                        echo "âœ… No critical errors in logs"
                    fi

                    # Verify backend services are accessible
                    echo ""
                    echo "ğŸ” Verifying backend services..."
                    curl -f http://localhost:8081/health || echo "âš ï¸  Auth service not healthy"
                    curl -f http://localhost:8082/health || echo "âš ï¸  Inventory service not healthy"
                    curl -f http://localhost:8083/health || echo "âš ï¸  Order service not healthy"

                    echo ""
                    echo "âœ… Smoke tests completed!"
                    echo "ğŸ“± Telegram bot should now be responding to messages"
                    echo "   Test by sending /start to your bot"
                '''
            }
        }
    }

    post {
        always {
            script {
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "           Pipeline Completed"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "ğŸ—ï¸  Build: #${BUILD_NUMBER}"
                echo "ğŸ“Š Status: ${currentBuild.result ?: 'SUCCESS'}"
                echo "â±ï¸  Duration: ${currentBuild.durationString.replace(' and counting', '')}"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            }

            // Clean up Docker resources
            sh '''
                echo "ğŸ§¹ Cleaning up Docker resources..."

                # Clean up old local images (keep only last 3 builds + latest)
                echo ""
                echo "Cleaning up old local images (${LOCAL_IMAGE_NAME})..."
                docker images ${LOCAL_IMAGE_NAME} --format "{{.ID}} {{.Tag}}" | \
                    grep -v "latest" | \
                    tail -n +4 | \
                    awk '{print $1}' | \
                    xargs -r docker rmi -f || true

                # Clean up old remote images (keep only last 3 builds + latest)
                echo ""
                echo "Cleaning up old remote images (${REMOTE_IMAGE_NAME})..."
                docker images ${REMOTE_IMAGE_NAME} --format "{{.ID}} {{.Tag}}" | \
                    grep -v "latest" | \
                    tail -n +4 | \
                    awk '{print $1}' | \
                    xargs -r docker rmi -f || true

                # Remove stopped containers
                echo ""
                echo "Removing stopped containers..."
                docker container prune -f || true

                # Remove dangling images (untagged)
                echo ""
                echo "Removing dangling images..."
                docker image prune -f || true

                # Remove unused build cache
                echo ""
                echo "Removing unused build cache..."
                docker builder prune -f --keep-storage 2GB || true

                # Show disk usage
                echo ""
                echo "Current Docker disk usage:"
                docker system df
            '''
        }
        success {
            echo "âœ… TELEGRAM BOT SERVICE BUILD SUCCEEDED!"
            echo "ğŸ“± Bot is ready to receive messages at Telegram"
            // Add notifications here (Slack, email, etc.)
        }
        failure {
            echo "âŒ TELEGRAM BOT SERVICE BUILD FAILED!"
            // Add failure notifications here
        }
        unstable {
            echo "âš ï¸  TELEGRAM BOT SERVICE BUILD IS UNSTABLE!"
        }
    }
}
